<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="crud-table">

    <!-- scoped CSS for this element -->
    <style>
    </style>

    <template>
        <div>
            <h1><a href="#" onclick="return crudClassesList.show();">классы</a> / <span id="title"></span></h1>
            <div id="list_meta" style="padding: 10px; background-color: #ddd; text-align: right;"><span id="loaded_count"></span></div>
            <div>
                <content></content>
            </div>
            <div style="padding: 10px; background-color: #ddd; text-align: right;">TABLE FOOTER</div>
        </div>
    </template>

    <script>
        var obj_count = 0;

        var CrudTable = Polymer({
            is: "crud-table",
            //_obj_class_name: '',

            factoryImpl: function(class_name) {
                //this._obj_class_name = class_name;
                this.$.title.textContent = crud.getClassTitleByName(class_name);

                var class_config = crud.config[class_name];
                var table_config = class_config.table;

                if (table_config.search_fields){
                    for (var i in table_config.search_fields){
                        var search_field_config = table_config.search_fields[i];
                        var search_field_name = search_field_config.field_name;

                        var sf = document.createElement('input');
                        sf.dataset.class_name = class_name;
                        sf.dataset.field_name = search_field_name;
                        sf.onkeyup = function(){
                            var filter_string = this.value;

                            var crud_table_class_name = this.dataset.class_name;
                            var search_field_name = this.dataset.field_name;
                            var crud_list_component = crud.lists[crud_table_class_name];

                            Polymer.dom(crud_list_component).innerHTML = '';

                            var backend_command = {
                                class_name: class_name,
                                filters: [
                                    {
                                        field_name: search_field_name,
                                        value: filter_string
                                    }
                                ]
                            };

                            socket.emit('objects_list', backend_command);
                        };
                        Polymer.dom(this.$.list_meta).appendChild(sf);
                    }
                }

                var backend_command = {
                    class_name: class_name,
                    order_by: table_config.group_by,
                    limit: table_config.page_size
                };

                socket.emit('objects_list', backend_command);
            },

            addObject: function(obj){
                //var class_name = this._obj_class_name;

                obj_count++;
                Polymer.dom(this.$.loaded_count).textContent = 'loaded: ' + obj_count;

                var obj_full_id = model.getFullIdForObj(obj);
                storage.setObject(obj_full_id, obj);

                var new_block_component = new CrudTableRow(obj_full_id, this);
                Polymer.dom(this).appendChild(new_block_component); // appends to <content>
            }
        });
    </script>

</dom-module>