<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="crud-table">

    <!-- scoped CSS for this element -->
    <style>
        :host {
            display: table;
            width: 100%;
            background-color: white;
        }

        #title {
            font-weight: bold;
        }

        #table_container {
            display: table-cell;
            vertical-align: top;
            /*padding: 10px;*/
            width: 100%;
            background-color: white;
        }

        #table_container.narrow {
            width: 30%;
            /*background-color: #f9f9f9;*/
        }

        #children_container {
            vertical-align: top;
            padding: 20px;
            display: none;
        }

        #children_container.wide {
            background-color: #f9f9f9;
            display: table-cell;
        }

        #controls {
            padding: 20px;
            /*background-color: #eee;*/
            display: none;
        }

        #controls.visible {
            display: block;
        }

        #toggle_filters {
            cursor: pointer;
            /*font-size: 10px;*/
        }
    </style>

    <template>
        <div style="display: table-row;">
            <div id="table_container">
                <paper-material elevation="1">
                    <div style="padding: 20px 10px 0 20px;">
                        <!--<span id="title">TITLE</span>-->
                        <span id="toggle_filters"
                              on-click="crud_toggleFilters">&#x2630;</span>
                    </div>

                    <div id="controls">
                        <div id="filters"></div>
                        <div id="orders"></div>
                    </div>
                    <div id="list_container">
                    </div>
                </paper-material>
            </div>
            <div id="children_container">
            </div>
        </div>
    </template>

    <script>
        var CrudTable = {
            component: Polymer({
                is: "crud-table",

                crud_toggleFilters: function () {
                    Polymer.dom(this.$.controls).classList.toggle('visible');
                },

                setAllRowsInactive: function() {
                    var rows = this.$.list_container.querySelectorAll('crud-table-row');
                    if (rows.length) {
                        for (var i = 0; i < rows.length; i++) {
                            var row_polymer = rows[i];
                            row_polymer.setInactive();
                        }
                    }
                },

                factoryImpl: function (class_name, filters_arr, orders_arr) {
                    this.crud_class_name = class_name;

                    this.$.filters.dataset.class_name = class_name;
                    //this.$.title.textContent = crud.getClassTitleByName(class_name);

                    CrudTable.renderFilters(class_name, this, filters_arr);
                    CrudTable.renderOrders(class_name, this, orders_arr);

                    this.apiQuery(class_name);
                },

                crud_replaceChildren: function (editor_component) {
                    var children_container = this.$.children_container;
                    var table_container = this.$.table_container;

                    children_container.innerHTML = '';
                    children_container.appendChild(editor_component);

                    children_container.classList.add('wide');
                    table_container.classList.add('narrow');
                },

                appendWhereFilters: function (query_url) {
                    var filters = this.$.filters.querySelectorAll('crud-table-filter');
                    if (filters.length) {
                        for (var i = 0; i < filters.length; i++) {
                            var filter_element = filters[i];
                            var filter_field_name = filter_element.crud_field_name;
                            var filter_value = filter_element.crud_field_value;
                            if (filter_value) {
                                query_url += '&filter[where][' + filter_field_name + ']=' + filter_value;
                            }
                        }
                    }

                    return query_url;
                },

                apiQuery: function (class_name, limit) {
                    Polymer.dom(this.$.list_container).innerHTML = '';

                    var api_url = 'localhost:3001';
                    //var api_url = 'localhost:8080';

                    if (!limit) {
                        limit = 100;
                    }

                    var query_url = 'http://' + api_url + '/api/' + class_name;
                    query_url += '?1=1';

                    query_url += '&filter[limit]=' + limit;

                    query_url = this.appendWhereFilters(query_url);
                    query_url = CrudTable.appendOrderFIlters(this, query_url);

                    var table_component = this;

                    $.ajax({
                        url: query_url, success: function (data) {
                            CrudTable.tableSuccess(data, table_component); // do not pass THIS - may be missing
                        }
                    });
                },

                crud_setActiveEditor: function(editor_polymer){
                    var append_context = true;
                    if (this.crud_active_editor){
                        append_context = false;
                    }

                    this.crud_active_editor = editor_polymer;
                    this.crud_replaceChildren(editor_polymer);

                    var classes_list_polymer =  document.getElementsByTagName('crud-classes-list')[0];
                    console.assert(classes_list_polymer);

                    classes_list_polymer.crud_replaceChildren(this);
                    classes_list_polymer.crud_updateContext(this, append_context);
                },

                crud_getContextHash: function(){
                    var hash = {
                        type: 'crud-table',
                        class_name: this.crud_class_name
                    };

                    if (this.crud_active_editor){
                        hash.editor = this.crud_active_editor.crud_getContextHash();
                    }

                    return hash;
                },

                crud_getContextStr: function(){
                    var str = '';
                    str += this.crud_class_name;

                    if (this.crud_active_editor){
                        str += ' ' + this.crud_active_editor.crud_getContextStr();
                    }

                    return str;
                }
            }),

            appendOrderFIlters: function (table_component, query_url) {
                var filters = $(table_component.$.orders).find('paper-checkbox');
                if (filters.length) {
                    for (var i = 0; i < filters.length; i++) {
                        var filter_element = filters[i];
                        var filter_field_name = filter_element.dataset.field_name;
                        //var filter_value = filter_element.value;
                        if (filter_element.checked) {
                            query_url += '&filter[order]=' + filter_field_name + '%20DESC';
                        }
                    }
                }

                return query_url;
            },

            tableSuccess: function (data, table_component) {
                //var class_name = CrudTable.getClassNameForTableComponent(table_component);
                //table_component.$.title.textContent = crud.getClassTitleByName(class_name) + ' (' + data.length + ')';

                for (var i in data) {
                    var obj = data[i];
                    CrudTable.addObject(obj, table_component);
                }
            },

            addObject: function (obj, table_component) {
                var class_name = table_component.$.filters.dataset.class_name;
                obj._class_name = class_name;

                var obj_full_id = Model.getFullIdForObj(obj);
                storage.setObject(obj_full_id, obj);

                var new_block_component = new CrudTableRow(obj_full_id, table_component);
                Polymer.dom(table_component.$.list_container).appendChild(new_block_component); // appends to <content>
            },

            getTableForInnerElement: function (element) {
                return $(element).parents('crud-table')[0];
            },

            getClassNameForTableComponent: function (table_component) {
                return table_component.$.filters.dataset.class_name;
            },

            renderFilters: function (class_name, self_component, filters_arr) {
                var class_config = crud.config[class_name];
                var table_config = class_config.table;

                if ('search_fields' in table_config) {
                    for (var i in table_config.search_fields) {
                        var search_field_config = table_config.search_fields[i];
                        var search_field_name = search_field_config.field_name;

                        var search_field_value = '';

                        // сначала берем дефолтное значение фильтра из конфига
                        if ('value' in search_field_config) {
                            var search_field_value = search_field_config.value;
                        }

                        // потом берем переопределенное значение фильтра (если таблица создается программно и фильтр определяется контекстом)
                        if (filters_arr) {
                            if (filters_arr[search_field_name]) {
                                search_field_value = filters_arr[search_field_name];
                            }
                        }

                        var filter_component = new CrudTableFilter.component(self_component, class_name, search_field_name, search_field_value);

                        Polymer.dom(self_component.$.filters).appendChild(filter_component);
                    }
                }
            },

            renderOrders: function (class_name, self_component, orders_arr) {
                var class_config = crud.config[class_name];
                var table_config = class_config.table;

                if (table_config.order_fields) {
                    for (var i in table_config.order_fields) {
                        var order_field_config = table_config.order_fields[i];
                        var order_field_name = order_field_config.field_name;
                        var order_field_value = '';

                        if (orders_arr) {
                            if (filters_arr[order_field_name]) {
                                order_field_value = filters_arr[order_field_name];
                            }
                        }

                        var filter_component = new CrudTableOrder.component(self_component, class_name, order_field_name, order_field_value);

                        Polymer.dom(self_component.$.orders).appendChild(filter_component);
                    }
                }
            }
        };
    </script>

</dom-module>