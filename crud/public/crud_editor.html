<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="crud-editor">

    <style>

        paper-material {
            padding: 10px;
        }

        :host {
        }

        iron-pages > div {
            /*border-top: 1px solid #ddd;*/
        }

    </style>

    <template>
        <!--<paper-material>-->
            <paper-tabs id="tabs" selected="0">
            </paper-tabs>
            <iron-pages id="pages" selected="0">
                <!--<div>
                    </content>
                    <div style="text-align: right;">
                        <paper-button raised onclick="return crudEditor.saveEditor();">Сохранить</paper-button>
                    </div>
                </div>-->
            </iron-pages>
        <!--</paper-material>-->
    </template>

    <script>

        var crudEditor = {
            component: Polymer({
                is: "crud-editor",

                obj_full_id: '',

                crud_getContextHash: function(){
                    var hash = {};

                    hash.obj_full_id = this.obj_full_id;
                    hash.tab = this.$.pages.selected;

                    return hash;
                },

                crud_getContextStr: function(){
                    var str = '';

                    str += this.obj_full_id;

                    return str;
                },

                factoryImpl: function (obj_full_id, table_polymer) {
                    this.obj_full_id = obj_full_id;

                    var obj = storage.getObject(obj_full_id);

                    //this.$.title.textContent = Model.getTitleForObj(obj);

                    var page_index = 0; // вся жесть вокруг page_index изза почемуто невозможности выбрать список табов нормальным селектором и навесить онклики
                    var pages = this.$.pages;

                    var crud_config_for_class = crud.config[obj._class_name];
                    for (var tab_index = 0; tab_index < crud_config_for_class.editor.length; tab_index++) {
                        var tab_config = crud_config_for_class.editor[tab_index];

                        var tab = document.createElement("paper-tab");
                        tab.textContent = tab_config.tab_title;
                        tab.dataset.page_index = page_index;
                        tab.onclick = function(){
                            pages.selected = this.dataset.page_index;
                            var classes_list_polymer =  document.getElementsByTagName('crud-classes-list')[0];
                            console.assert(classes_list_polymer);
                            classes_list_polymer.crud_updateContext(table_polymer, false);
                        };
                        Polymer.dom(this.$.tabs).appendChild(tab);

                        var page_element = document.createElement("div");
                        Polymer.dom(this.$.pages).appendChild(page_element);

                        for (var field_index = 0; field_index < tab_config.fields.length; field_index++) {
                            var field_config = tab_config.fields[field_index];

                            var field_component = null;
                            switch (field_config.widget.name) {
                                case 'input':
                                    field_component = new CrudEditorFieldInput(obj_full_id, field_config.field_name, field_config.widget.params);
                                    break;
                                case 'textarea':
                                    field_component = new CrudEditorFieldTextarea(obj_full_id, field_config.field_name, field_config.widget.params);
                                    break;
                            }

                            Polymer.dom(page_element).appendChild(field_component);
                        }

                        var buttons_polymer = document.createElement('crud-editor-save-buttons');
                        Polymer.dom(page_element).appendChild(buttons_polymer);

                        page_index++;
                    }


                    if (crud_config_for_class.linked_models){
                        for (var i in crud_config_for_class.linked_models){
                            var linked_model_config = crud_config_for_class.linked_models[i];
                            var linked_class_name = linked_model_config.class_name;
                            var link_field = linked_model_config.reference_field;
                            var filters_arr = [];
                            filters_arr.push({'field_name': link_field, 'value': Model.getIdForObj(obj)});

                            var list = new CrudTable.component(linked_class_name, filters_arr);
                            //crud.lists[class_name] = list;

                            var div = document.createElement("div");
                            div.appendChild(list);

                            Polymer.dom(this.$.pages).appendChild(div);

                            var tab = document.createElement("paper-tab");
                            tab.dataset.page_index = page_index;
                            tab.onclick = function(){
                                pages.selected = this.dataset.page_index;
                                var classes_list_polymer =  document.getElementsByTagName('crud-classes-list')[0];
                                console.assert(classes_list_polymer);
                                classes_list_polymer.crud_updateContext(table_polymer, false);
                            };


                            tab.textContent = crud.getClassTitleByName(linked_class_name);
                            Polymer.dom(this.$.tabs).appendChild(tab);

                            page_index++;
                        }
                    }

                    // нужно, чтобы табы правильно отрисовались (какой-то баг?)
                    this.$.pages.selected = 0;
                    this.$.tabs.selected = 0;
                }
            }),

            saveEditor: function () {
                var obj_full_id = this.obj_full_id;
                var obj = storage.getObject(obj_full_id);

                var crud_config_for_class = crud.config[obj._class_name];
                for (var i = 0; i < crud_config_for_class.editor.length; i++) {
                    var field_config = crud_config_for_class.editor[i];
                    var property_name = field_config.field_name;

                    var field_editor_element = document.querySelector('.editor_field__' + property_name);
                    var field_value = field_editor_element.value;
                    console.log(field_value);

                    var data = {};
                    data.object_class_name = obj._class_name;
                    data.object_id = obj.id;
                    data.field_name = property_name;
                    data.field_value = field_value;

                    socket.emit('update_object_field', data);
                }
            }
        };
    </script>

</dom-module>